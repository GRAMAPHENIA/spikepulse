<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spikepulse - Test Monitoreo de Rendimiento</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1A1A2E 0%, #0F0F0F 50%, #16213E 100%);
            color: #FFFFFF;
            font-family: 'Rajdhani', sans-serif;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .test-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            color: #FFD700;
            text-shadow: 0 0 20px #FFD700;
            margin-bottom: 0.5rem;
        }

        .test-subtitle {
            font-size: 1.2rem;
            color: #9F7AEA;
            margin-bottom: 2rem;
        }

        .game-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        #gameCanvas {
            border: 2px solid #9F7AEA;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(159, 122, 234, 0.3);
            background: #0F0F0F;
        }

        .controls-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #9F7AEA;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .controls-title {
            font-family: 'Orbitron', monospace;
            color: #FFD700;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .control-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            background: #9F7AEA;
            color: white;
            border: none;
            border-radius: 4px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #FFD700;
            color: #0F0F0F;
            transform: translateY(-2px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #FF6B6B;
            border-radius: 8px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .info-title {
            font-family: 'Orbitron', monospace;
            color: #FF6B6B;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .info-text {
            line-height: 1.6;
            color: #CCCCCC;
        }

        .info-text strong {
            color: #FFD700;
        }

        .keyboard-shortcuts {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shortcut {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .shortcut-key {
            background: #2D3748;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .test-title {
                font-size: 2rem;
            }
            
            .control-group {
                flex-direction: column;
            }
            
            .control-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body class="spikepulse-app">
    <div class="test-container">
        <header class="test-header">
            <h1 class="test-title">SPIKEPULSE</h1>
            <p class="test-subtitle">Test de Monitoreo de Rendimiento</p>
        </header>

        <div class="game-container">
            <canvas id="gameCanvas" width="800" height="400">
                Tu navegador no soporta canvas. Por favor actualiza tu navegador.
            </canvas>
        </div>

        <div class="controls-panel">
            <h3 class="controls-title">Controles de Prueba</h3>
            
            <div class="control-group">
                <button class="control-btn" id="startBtn">Iniciar Motor</button>
                <button class="control-btn" id="stopBtn">Detener Motor</button>
                <button class="control-btn" id="pauseBtn">Pausar</button>
                <button class="control-btn" id="resumeBtn">Reanudar</button>
            </div>

            <div class="control-group">
                <button class="control-btn" id="togglePerformanceBtn">Alternar Display Rendimiento</button>
                <button class="control-btn" id="forceOptimizationBtn">Forzar Optimizaci√≥n</button>
                <button class="control-btn" id="cleanupMemoryBtn">Limpiar Memoria</button>
            </div>

            <div class="control-group">
                <button class="control-btn" id="highPerformanceBtn">Rendimiento Alto</button>
                <button class="control-btn" id="mediumPerformanceBtn">Rendimiento Medio</button>
                <button class="control-btn" id="lowPerformanceBtn">Rendimiento Bajo</button>
            </div>

            <div class="control-group">
                <button class="control-btn" id="stressTestBtn">Test de Estr√©s</button>
                <button class="control-btn" id="memoryLeakBtn">Simular Memory Leak</button>
                <button class="control-btn" id="resetTestBtn">Resetear Test</button>
            </div>
        </div>

        <div class="info-panel">
            <h3 class="info-title">Informaci√≥n del Test</h3>
            <div class="info-text">
                <p>Este test permite verificar el funcionamiento del sistema de monitoreo de rendimiento de Spikepulse.</p>
                
                <p><strong>Caracter√≠sticas probadas:</strong></p>
                <ul>
                    <li>Monitoreo de FPS en tiempo real</li>
                    <li>Seguimiento de uso de memoria</li>
                    <li>Detecci√≥n autom√°tica de problemas de rendimiento</li>
                    <li>Optimizaciones autom√°ticas y manuales</li>
                    <li>Display visual de m√©tricas</li>
                    <li>Gesti√≥n de memoria y garbage collection</li>
                </ul>

                <div class="keyboard-shortcuts">
                    <h4 style="color: #9F7AEA; margin-bottom: 0.5rem;">Atajos de Teclado:</h4>
                    <div class="shortcut">
                        <span>Alternar Display de Rendimiento</span>
                        <span class="shortcut-key">F3</span>
                    </div>
                    <div class="shortcut">
                        <span>Forzar Optimizaci√≥n</span>
                        <span class="shortcut-key">Ctrl+Shift+P</span>
                    </div>
                    <div class="shortcut">
                        <span>Limpiar Memoria</span>
                        <span class="shortcut-key">Ctrl+Shift+M</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GameEngine } from './src/core/GameEngine.js';
        import { GAME_CONFIG, DEV_CONFIG_OVERRIDES } from './src/config/GameConfig.js';

        // Configuraci√≥n para el test con monitoreo habilitado
        const testConfig = {
            ...GAME_CONFIG,
            ...DEV_CONFIG_OVERRIDES,
            debug: {
                ...GAME_CONFIG.debug,
                ...DEV_CONFIG_OVERRIDES.debug,
                showPerformanceDisplay: true,
                showPerformanceGraphs: true
            }
        };

        // Inicializar motor del juego
        let gameEngine = null;
        let stressTestInterval = null;
        let memoryLeakObjects = [];

        // Funci√≥n para inicializar el motor
        function initializeEngine() {
            try {
                gameEngine = new GameEngine(testConfig);
                console.log('Motor de juego inicializado para test de rendimiento');
                
                // Configurar eventos de test
                setupTestEvents();
                
            } catch (error) {
                console.error('Error inicializando motor:', error);
                alert('Error inicializando el motor del juego. Revisa la consola para m√°s detalles.');
            }
        }

        // Configurar eventos espec√≠ficos del test
        function setupTestEvents() {
            if (!gameEngine) return;

            // Eventos de rendimiento
            gameEngine.eventBus.on('performance:alert', (data) => {
                console.warn(`üö® Alerta de rendimiento: ${data.message}`);
            });

            gameEngine.eventBus.on('optimizer:optimization-completed', (data) => {
                console.log(`‚úÖ Optimizaci√≥n completada: ${data.optimizations.length} estrategias aplicadas`);
            });

            gameEngine.eventBus.on('memory:gc-detected', (data) => {
                console.log(`üóëÔ∏è Garbage Collection detectado: ${data.memoryFreed} bytes liberados`);
            });

            // Mostrar estad√≠sticas cada 5 segundos
            setInterval(() => {
                if (gameEngine && gameEngine.isRunning) {
                    const stats = gameEngine.getPerformanceSummary();
                    console.log('üìä Estad√≠sticas de rendimiento:', stats);
                }
            }, 5000);
        }

        // Configurar controles
        function setupControls() {
            // Controles b√°sicos del motor
            document.getElementById('startBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.start();
                    console.log('Motor iniciado');
                }
            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.stop();
                    console.log('Motor detenido');
                }
            });

            document.getElementById('pauseBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.pause();
                    console.log('Motor pausado');
                }
            });

            document.getElementById('resumeBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.resume();
                    console.log('Motor reanudado');
                }
            });

            // Controles de rendimiento
            document.getElementById('togglePerformanceBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.togglePerformanceDisplay();
                    console.log('Display de rendimiento alternado');
                }
            });

            document.getElementById('forceOptimizationBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.forceOptimization();
                    console.log('Optimizaci√≥n forzada');
                }
            });

            document.getElementById('cleanupMemoryBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.cleanupMemory();
                    console.log('Limpieza de memoria ejecutada');
                }
            });

            // Controles de nivel de rendimiento
            document.getElementById('highPerformanceBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.setPerformanceLevel('high');
                    console.log('Nivel de rendimiento: Alto');
                }
            });

            document.getElementById('mediumPerformanceBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.setPerformanceLevel('medium');
                    console.log('Nivel de rendimiento: Medio');
                }
            });

            document.getElementById('lowPerformanceBtn').addEventListener('click', () => {
                if (gameEngine) {
                    gameEngine.setPerformanceLevel('low');
                    console.log('Nivel de rendimiento: Bajo');
                }
            });

            // Tests de estr√©s
            document.getElementById('stressTestBtn').addEventListener('click', () => {
                toggleStressTest();
            });

            document.getElementById('memoryLeakBtn').addEventListener('click', () => {
                simulateMemoryLeak();
            });

            document.getElementById('resetTestBtn').addEventListener('click', () => {
                resetTest();
            });
        }

        // Test de estr√©s de CPU
        function toggleStressTest() {
            if (stressTestInterval) {
                clearInterval(stressTestInterval);
                stressTestInterval = null;
                console.log('Test de estr√©s detenido');
                document.getElementById('stressTestBtn').textContent = 'Test de Estr√©s';
            } else {
                console.log('Iniciando test de estr√©s...');
                document.getElementById('stressTestBtn').textContent = 'Detener Test';
                
                stressTestInterval = setInterval(() => {
                    // Crear carga de CPU artificial
                    const start = performance.now();
                    while (performance.now() - start < 10) {
                        // Operaciones intensivas
                        Math.random() * Math.random();
                    }
                    
                    // Crear objetos temporales
                    for (let i = 0; i < 100; i++) {
                        const obj = {
                            id: Math.random(),
                            data: new Array(100).fill(Math.random()),
                            timestamp: Date.now()
                        };
                    }
                }, 16); // Cada frame
            }
        }

        // Simular memory leak
        function simulateMemoryLeak() {
            console.log('Simulando memory leak...');
            
            for (let i = 0; i < 1000; i++) {
                const leakObject = {
                    id: i,
                    largeArray: new Array(1000).fill(Math.random()),
                    circularRef: null,
                    timestamp: Date.now()
                };
                
                // Crear referencia circular
                leakObject.circularRef = leakObject;
                memoryLeakObjects.push(leakObject);
            }
            
            console.log(`Memory leak simulado: ${memoryLeakObjects.length} objetos creados`);
        }

        // Resetear test
        function resetTest() {
            console.log('Reseteando test...');
            
            // Detener test de estr√©s
            if (stressTestInterval) {
                clearInterval(stressTestInterval);
                stressTestInterval = null;
                document.getElementById('stressTestBtn').textContent = 'Test de Estr√©s';
            }
            
            // Limpiar memory leak
            memoryLeakObjects.forEach(obj => {
                obj.circularRef = null;
                obj.largeArray = null;
            });
            memoryLeakObjects.length = 0;
            
            // Forzar limpieza
            if (gameEngine) {
                gameEngine.cleanupMemory();
            }
            
            console.log('Test reseteado');
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando test de monitoreo de rendimiento...');
            initializeEngine();
            setupControls();
            
            // Mostrar instrucciones
            console.log(`
üìã INSTRUCCIONES DEL TEST:
1. Haz clic en "Iniciar Motor" para comenzar
2. Presiona F3 para mostrar/ocultar el display de rendimiento
3. Usa los botones para probar diferentes funcionalidades
4. Observa las m√©tricas en tiempo real
5. Revisa la consola para logs detallados

üéÆ ¬°Disfruta probando el sistema de monitoreo!
            `);
        });

        // Limpiar al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            resetTest();
            if (gameEngine) {
                gameEngine.destroy();
            }
        });
    </script>
</body>
</html>